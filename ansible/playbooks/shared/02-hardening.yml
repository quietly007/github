---
# HARDENING - Security hardening
# Usage: ansible-playbook playbooks/02-hardening.yml -l <host>

- name: Apply server hardening
  hosts: all
  become: true
  vars_files:
    - "{{ playbook_dir }}/../../group_vars/all.yml"

  tasks:
    #=== SYSCTL ===
    - name: Deploy sysctl hardening
      ansible.builtin.template:
        src: "{{ playbook_dir | dirname | dirname }}/templates/sysctl-hardening.conf.j2"
        dest: /etc/sysctl.d/99-hardening.conf
        mode: '0644'
      notify: Reload sysctl

    #=== GRUB IPV6 DISABLE ===
    - name: Set grub backup dir
      ansible.builtin.set_fact:
        grub_backup_dir: "/home/{{ admin_user }}/.copilot/backups/grub_ipv6_disable_{{ lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ') }}"

    - name: Ensure grub backup dir exists
      ansible.builtin.file:
        path: "{{ grub_backup_dir }}"
        state: directory
        mode: '0700'

    - name: Backup /etc/default/grub
      ansible.builtin.copy:
        src: /etc/default/grub
        dest: "{{ grub_backup_dir }}/grub"
        remote_src: true
        mode: '0600'

    - name: Read GRUB_CMDLINE_LINUX_DEFAULT
      ansible.builtin.command: bash -lc "grep -E '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub"
      register: grub_cmdline
      changed_when: false
      failed_when: false

    - name: Ensure GRUB_CMDLINE_LINUX_DEFAULT includes ipv6.disable=1
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: "GRUB_CMDLINE_LINUX_DEFAULT=\"{{ (grub_cmdline.stdout | regex_replace('^GRUB_CMDLINE_LINUX_DEFAULT=\"(.*)\"$', '\\1') if grub_cmdline.rc == 0 else 'quiet') }} ipv6.disable=1\""
        create: true
        mode: '0644'
      when: "'ipv6.disable=1' not in grub_cmdline.stdout"
      notify: Update grub

    #=== DOCKER DAEMON ===
    - name: Ensure docker config dir exists
      ansible.builtin.file:
        path: /etc/docker
        state: directory
        mode: '0755'

    - name: Configure Docker daemon
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        mode: '0644'
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "default-ulimits": {
              "nofile": {
                "Name": "nofile",
                "Hard": 65536,
                "Soft": 65536
              }
            },
            "ipv6": false,
            "ip6tables": false,
            "no-new-privileges": true,
            "live-restore": true
          }
      notify: Reload docker

    #=== SYSTEMD-RESOLVED ===
    - name: Ensure systemd-resolved drop-in dir exists
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory
        mode: '0755'

    - name: Disable LLMNR and mDNS
      ansible.builtin.copy:
        dest: /etc/systemd/resolved.conf.d/99-quietly.conf
        mode: '0644'
        content: |
          [Resolve]
          LLMNR=no
          MulticastDNS=no
      notify: Restart systemd-resolved

    #=== JOURNALD RETENTION ===
    - name: Ensure journald drop-in dir exists
      ansible.builtin.file:
        path: /etc/systemd/journald.conf.d
        state: directory
        mode: '0755'

    - name: Configure journald retention
      ansible.builtin.copy:
        dest: /etc/systemd/journald.conf.d/99-retention.conf
        mode: '0644'
        content: |
          [Journal]
          SystemMaxUse=200M
          SystemMaxFileSize=50M
          MaxRetentionSec=7day
      notify: Restart systemd-journald

    #=== FAIL2BAN ===
    - name: Install fail2ban
      ansible.builtin.apt:
        name: fail2ban
        state: present
        update_cache: true

    - name: Configure fail2ban jail
      ansible.builtin.template:
        src: "{{ playbook_dir | dirname | dirname }}/templates/jail.local.j2"
        dest: /etc/fail2ban/jail.local
        mode: '0644'
      notify: Restart fail2ban

    - name: Enable and start fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        enabled: true
        state: started

    #=== FILE LIMITS ===
    - name: Configure file limits
      ansible.builtin.copy:
        dest: /etc/security/limits.d/99-quietly.conf
        mode: '0644'
        content: |
          * soft nofile 65536
          * hard nofile 65536
          root soft nofile 65536
          root hard nofile 65536

  handlers:
    - name: Reload sysctl
      ansible.builtin.command: sysctl --system
      changed_when: true

    - name: Update grub
      ansible.builtin.command: update-grub
      changed_when: true

    - name: Reload docker
      ansible.builtin.systemd:
        name: docker
        state: reloaded

    - name: Restart fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        state: restarted

    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted

    - name: Restart systemd-journald
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted
