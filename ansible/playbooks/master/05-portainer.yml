---
# MASTER PORTAINER - Docker management UI
# Usage: ansible-playbook -i inventory/production.ini playbooks/05-portainer.yml

- name: Deploy Portainer on Master
  hosts: master
  become: true
  become_user: "{{ admin_user }}"
  vars_files:
    - "{{ playbook_dir }}/../../group_vars/all.yml"
    - "{{ playbook_dir }}/../../host_vars/master.yml"

  tasks:
    - name: Pull latest from GitHub
      ansible.builtin.git:
        repo: "https://github.com/quietly007/quietly.its.me.git"
        dest: "{{ ansible_env.HOME }}"
        version: main
        update: yes
        force: no
      when: not ansible_check_mode

    - name: Check compose file exists
      ansible.builtin.stat:
        path: "{{ compose_dir }}/portainer/docker-compose.yaml"
      register: portainer_compose

    - name: Fail if compose file missing
      ansible.builtin.fail:
        msg: "Compose file missing at {{ compose_dir }}/portainer/docker-compose.yaml"
      when: not portainer_compose.stat.exists

    - name: Start Portainer
      community.docker.docker_compose_v2:
        project_src: "{{ compose_dir }}/portainer"
        state: present

    - name: Seed health defaults in check mode
      ansible.builtin.set_fact:
        portainer_health:
          status: 0
      when: ansible_check_mode

    - name: Wait for Portainer healthy
      ansible.builtin.uri:
        url: "https://localhost:9443"
        status_code: 200
        validate_certs: no
      register: portainer_health
      retries: 10
      delay: 5
      until: portainer_health.status == 200
      ignore_errors: true
      when: not ansible_check_mode

    - name: Show status
      ansible.builtin.debug:
        msg: "Portainer {{ 'HEALTHY' if (portainer_health.status | default(0)) == 200 else 'NOT HEALTHY' }}"
