---
# SECRETS SETUP - Create structure and sync from Master
# Usage: ansible-playbook -i inventory/bootstrap.ini playbooks/master/00-secrets.yml -l lady
#
# Creates secrets directory structure and copies secrets from Master (controller).

- name: Setup secrets directory structure
  hosts: all
  become: true
  vars_files:
    - "{{ playbook_dir }}/../../group_vars/all.yml"

  vars:
    secrets_structure_selected: "{{ secrets_structure_master if is_master | default(false) else secrets_structure_lady }}"

  tasks:
    - name: Create main secrets directory
      ansible.builtin.file:
        path: "{{ secrets_dir }}"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0700'

    - name: Create service secrets directories
      ansible.builtin.file:
        path: "{{ secrets_dir }}/{{ item }}"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0700'
      loop: "{{ secrets_structure_selected }}"

    # ============================================================
    # SYNC LADY SECRETS FROM MASTER (controller)
    # ============================================================
    - name: Sync Lady secrets from Master
      when: not (is_master | default(false))
      block:
        # Cloudflare token (for Traefik)
        - name: Copy Cloudflare token
          ansible.builtin.copy:
            src: "{{ lookup('env','HOME') }}/.secrets/traefik/cf-token"
            dest: "{{ secrets_dir }}/traefik/cf-token"
            owner: "{{ admin_user }}"
            group: "{{ admin_user }}"
            mode: '0600'
          ignore_errors: yes

        # GitHub token
        - name: Copy GitHub token
          ansible.builtin.copy:
            src: "{{ lookup('env','HOME') }}/.secrets/github/token"
            dest: "{{ secrets_dir }}/github/token"
            owner: "{{ admin_user }}"
            group: "{{ admin_user }}"
            mode: '0600'
          ignore_errors: yes

        # Headscale authkey (for Tailscale)
        - name: Copy Headscale authkey
          ansible.builtin.copy:
            src: "{{ lookup('env','HOME') }}/.secrets/headscale/lady-authkey"
            dest: "{{ secrets_dir }}/headscale/lady-authkey"
            owner: "{{ admin_user }}"
            group: "{{ admin_user }}"
            mode: '0600'
          ignore_errors: yes

        # Traefik CF token (same as cloudflare, for backwards compat)
        - name: Create traefik secrets dir
          ansible.builtin.file:
            path: "{{ secrets_dir }}/traefik"
            state: directory
            owner: "{{ admin_user }}"
            group: "{{ admin_user }}"
            mode: '0700'

        - name: Copy Traefik CF token
          ansible.builtin.copy:
            src: "{{ lookup('env','HOME') }}/.secrets/traefik/cf-token"
            dest: "{{ secrets_dir }}/traefik/cf-token"
            owner: "{{ admin_user }}"
            group: "{{ admin_user }}"
            mode: '0600'
          ignore_errors: yes

    - name: Show secrets status
      ansible.builtin.debug:
        msg: "Secrets synced to {{ secrets_dir }}. Verify with: ls -la {{ secrets_dir }}/*/"
