---
#
# Monitoring Stack Deployment Playbook
# Deploys: Homepage, Uptime Kuma, Ntfy, Prometheus, Grafana, Loki, Alertmanager, agents
#
- name: Deploy monitoring stack from GitHub
  hosts: localhost
  connection: local
  become: false
  vars:
    github_repo: "https://github.com/qui3tly/qui3tly.cloud.git"
    monitoring_services:
      - prometheus
      - loki
      - node-exporter
      - cadvisor
      - promtail
      - alertmanager
      - grafana
      - homepage
      - uptime-kuma
      - ntfy

  tasks:
    - name: Ensure monitoring network exists
      docker_network:
        name: monitoring
        driver: bridge
        ipam_config:
          - subnet: "172.30.0.0/24"
        state: present

    - name: Pull monitoring stack from GitHub
      git:
        repo: "{{ github_repo }}"
        dest: "/tmp/qui3tly-monitoring-deploy"
        version: main
        force: yes

    - name: Deploy compose files
      synchronize:
        src: "/tmp/qui3tly-monitoring-deploy/monitoring/{{ item }}/"
        dest: "{{ ansible_env.HOME }}/.docker-compose/{{ item }}/"
        delete: no
      loop: "{{ monitoring_services }}"

    - name: Deploy configs
      synchronize:
        src: "/tmp/qui3tly-monitoring-deploy/monitoring/{{ item }}/config/"
        dest: "{{ ansible_env.HOME }}/.docker/{{ item }}/config/"
        delete: no
      loop:
        - homepage
        - prometheus
        - grafana
        - loki
        - promtail
        - alertmanager
      when: item != 'node-exporter' and item != 'cadvisor' and item != 'uptime-kuma' and item != 'ntfy'

    - name: Start monitoring services in order
      shell: |
        cd {{ ansible_env.HOME }}/.docker-compose/{{ item }} && docker compose up -d
      loop:
        - prometheus
        - loki
        - node-exporter
        - cadvisor
        - promtail
        - alertmanager
        - grafana
        - uptime-kuma
        - ntfy
        - homepage
      register: compose_result

    - name: Wait for services to be healthy
      shell: docker ps --filter "name={{ item }}" --format "{{{{.Status}}}}" | grep -q "healthy\|Up"
      loop: "{{ monitoring_services }}"
      retries: 30
      delay: 2
      until: result.rc == 0
      register: result
      ignore_errors: yes

    - name: Verify all URLs return 200 OK
      uri:
        url: "{{ item }}"
        status_code: 200
        validate_certs: yes
        timeout: 10
      loop:
        - "https://home.quietly.its.me"
        - "https://status.quietly.its.me"
        - "https://ntfy.quietly.its.me"
        - "https://grafana.quietly.its.me"
        - "https://prometheus.quietly.its.me"
        - "https://loki.quietly.its.me"
        - "https://alertmanager.quietly.its.me"
      retries: 5
      delay: 5
      register: url_check
      failed_when: false

    - name: Display deployment summary
      debug:
        msg: |
          ‚úÖ Monitoring Stack Deployed
          
          Services:
            ‚Ä¢ Homepage:       https://home.quietly.its.me
            ‚Ä¢ Uptime Kuma:    https://status.quietly.its.me
            ‚Ä¢ Ntfy:           https://ntfy.quietly.its.me
            ‚Ä¢ Grafana:        https://grafana.quietly.its.me
            ‚Ä¢ Prometheus:     https://prometheus.quietly.its.me
            ‚Ä¢ Loki:           https://loki.quietly.its.me
            ‚Ä¢ Alertmanager:   https://alertmanager.quietly.its.me
          
          üì± iOS Ntfy Setup:
            1. Install Ntfy app from App Store
            2. Add server: https://ntfy.quietly.its.me
            3. Subscribe to: qui3tly-critical, qui3tly-warnings, qui3tly-info
          
          ‚ö†Ô∏è Failed checks: {{ url_check.results | selectattr('failed', 'equalto', true) | list | length }}
