graph TB
    subgraph UpdateTypes["üîÑ Update Types"]
        Security[Security Updates<br/>Critical CVEs<br/>Priority: Immediate<br/>Timeline: 24h]
        
        Container[Container Images<br/>Docker Hub updates<br/>Priority: Medium<br/>Timeline: Monthly]
        
        System[System Packages<br/>apt upgrade<br/>Priority: Medium<br/>Timeline: Monthly]
        
        Config[Configuration Changes<br/>Service tuning<br/>Priority: Low<br/>Timeline: As needed]
    end

    subgraph PreUpgrade["üìã Pre-Upgrade Phase"]
        direction TB
        
        Check1[1. Check for Updates<br/>‚Ä¢ Docker image tags<br/>‚Ä¢ apt update<br/>‚Ä¢ GitHub releases<br/>‚Ä¢ Security advisories]
        
        Review[2. Review Changes<br/>‚Ä¢ Read changelogs<br/>‚Ä¢ Check breaking changes<br/>‚Ä¢ Review requirements<br/>‚Ä¢ Plan timeline]
        
        Backup[3. Full Backup<br/>‚Ä¢ Run docker_backup.sh<br/>‚Ä¢ Database dumps<br/>‚Ä¢ Config snapshot<br/>‚Ä¢ Git commit all]
        
        Snapshot[4. Take Snapshot<br/>‚Ä¢ VPS snapshot (Contabo)<br/>‚Ä¢ Point-in-time recovery<br/>‚Ä¢ Insurance policy]
        
        Notify[5. Notify Users<br/>‚Ä¢ Maintenance window<br/>‚Ä¢ Expected downtime<br/>‚Ä¢ Emergency contact]
        
        Check1 --> Review --> Backup --> Snapshot --> Notify
    end

    subgraph UpgradeExecution["‚öôÔ∏è Upgrade Execution"]
        direction TB
        
        subgraph ContainerUpgrade["Container Upgrade Process"]
            C1[1. Pull new image<br/>docker-compose pull]
            C2[2. Stop container<br/>docker-compose stop service]
            C3[3. Backup current<br/>Container logs<br/>Volume data]
            C4[4. Start new version<br/>docker-compose up -d]
            C5[5. Check logs<br/>docker logs -f service]
            C6[6. Health check<br/>Container status<br/>Service endpoint]
            
            C1 --> C2 --> C3 --> C4 --> C5 --> C6
        end
        
        subgraph SystemUpgrade["System Package Upgrade"]
            S1[1. Update package list<br/>apt update]
            S2[2. Review upgrades<br/>apt list --upgradable]
            S3[3. Upgrade packages<br/>apt upgrade -y]
            S4[4. Clean up<br/>apt autoremove]
            S5[5. Check services<br/>systemctl status]
            S6[6. Reboot if needed<br/>Kernel updates]
            
            S1 --> S2 --> S3 --> S4 --> S5 --> S6
        end
        
        subgraph ServiceSpecific["Service-Specific Upgrades"]
            SS1[Headscale Upgrade<br/>‚Ä¢ Download binary<br/>‚Ä¢ Stop service<br/>‚Ä¢ Replace binary<br/>‚Ä¢ Start service<br/>NATIVE systemd]
            
            SS2[Mailcow Upgrade<br/>‚Ä¢ cd /opt/mailcow<br/>‚Ä¢ git pull<br/>‚Ä¢ ./update.sh<br/>‚Ä¢ Restart stack]
            
            SS3[Traefik Upgrade<br/>‚Ä¢ Update compose<br/>‚Ä¢ Pull image<br/>‚Ä¢ Reload config<br/>‚Ä¢ Zero downtime]
        end
    end

    subgraph Testing["üß™ Post-Upgrade Testing"]
        direction LR
        
        T1[1. Service Health<br/>‚Ä¢ All containers up<br/>‚Ä¢ No restart loops<br/>‚Ä¢ Logs clean]
        
        T2[2. Functionality<br/>‚Ä¢ Web access works<br/>‚Ä¢ Mail flow works<br/>‚Ä¢ VPN connects<br/>‚Ä¢ Auth works]
        
        T3[3. Monitoring<br/>‚Ä¢ Prometheus scraping<br/>‚Ä¢ Grafana dashboards<br/>‚Ä¢ Alerts not firing]
        
        T4[4. Performance<br/>‚Ä¢ Response times OK<br/>‚Ä¢ CPU/RAM normal<br/>‚Ä¢ No errors]
        
        T1 --> T2 --> T3 --> T4
    end

    subgraph Verification["‚úÖ Verification Phase"]
        direction TB
        
        V1[Monitor for 24h<br/>Watch for issues<br/>Check logs<br/>User feedback]
        
        Decision{Upgrade Success?}
        
        Success[Success Path<br/>‚Ä¢ Document changes<br/>‚Ä¢ Update inventory<br/>‚Ä¢ Git commit<br/>‚Ä¢ Notify users]
        
        Rollback[Rollback Path<br/>‚Ä¢ Stop new version<br/>‚Ä¢ Restore from backup<br/>‚Ä¢ Start old version<br/>‚Ä¢ Investigate issue]
        
        V1 --> Decision
        Decision -->|Yes| Success
        Decision -->|No| Rollback
    end

    subgraph RollbackProcedure["‚Ü©Ô∏è Rollback Procedure (If Needed)"]
        direction TB
        
        R1[1. Stop failed service<br/>docker-compose stop]
        R2[2. Restore old image<br/>docker tag or pull]
        R3[3. Restore data<br/>From backup if corrupted]
        R4[4. Start old version<br/>docker-compose up -d]
        R5[5. Verify working<br/>Health checks pass]
        R6[6. Document issue<br/>Create incident report]
        
        R1 --> R2 --> R3 --> R4 --> R5 --> R6
    end

    subgraph Schedule["üìÖ Upgrade Schedule"]
        Monthly[Monthly Updates<br/>First Sunday 2am<br/>‚Ä¢ Container images<br/>‚Ä¢ System packages<br/>‚Ä¢ Non-critical fixes]
        
        Quarterly[Quarterly Major Upgrades<br/>Planned maintenance<br/>‚Ä¢ Major versions<br/>‚Ä¢ Database upgrades<br/>‚Ä¢ Architecture changes]
        
        Emergency[Emergency Patches<br/>Any time<br/>‚Ä¢ Critical CVEs<br/>‚Ä¢ Security breaches<br/>‚Ä¢ Service outages]
    end

    subgraph Automation2["ü§ñ Automation"]
        WatchUpdates[Watchtower Alternative<br/>Manual + controlled<br/>No auto-updates<br/>Review first]
        
        WeeklyCheck[Weekly Update Check<br/>Cron: 2am Sunday<br/>weekly_security.sh<br/>Report available updates]
        
        Dependabot[Dependabot (Future)<br/>GitHub alerts<br/>Automated PRs<br/>For IaC repos]
    end

    UpdateTypes --> PreUpgrade
    PreUpgrade --> UpgradeExecution
    UpgradeExecution --> Testing
    Testing --> Verification
    
    Verification -->|Failed| RollbackProcedure
    RollbackProcedure -.->|Retry later| PreUpgrade
    
    Schedule -.->|Triggers| PreUpgrade
    Automation2 -.->|Detects| UpdateTypes

    subgraph BestPractices["‚ú® Best Practices"]
        BP1[‚Ä¢ Always backup before upgrade]
        BP2[‚Ä¢ Test in dev first (future)]
        BP3[‚Ä¢ Read changelogs carefully]
        BP4[‚Ä¢ Upgrade one service at a time]
        BP5[‚Ä¢ Monitor after upgrade]
        BP6[‚Ä¢ Document everything]
        BP7[‚Ä¢ Have rollback plan ready]
        BP8[‚Ä¢ Schedule during low traffic]
    end

    subgraph RecentUpgrades["üìú Recent Upgrade History"]
        Recent1[Feb 10, 2026: Grafana 10.2 ‚Üí 10.3<br/>‚úÖ Success, no issues]
        Recent2[Feb 7, 2026: Traefik 2.11 ‚Üí 3.0<br/>‚úÖ Success, config changes]
        Recent3[Feb 1, 2026: System packages<br/>‚úÖ Success, 47 packages]
        Recent4[Jan 28, 2026: Mailcow 2024a ‚Üí 2024b<br/>‚úÖ Success + DR test]
    end

    classDef security fill:#d62828,stroke:#fff,stroke-width:2px,color:#fff
    classDef normal fill:#326ce5,stroke:#fff,stroke-width:2px,color:#fff
    classDef test fill:#00d4aa,stroke:#fff,stroke-width:2px,color:#000
    classDef rollback fill:#f77f00,stroke:#fff,stroke-width:2px,color:#fff

    class Security,Emergency security
    class Container,System,Config,UpgradeExecution normal
    class Testing,Verification test
    class RollbackProcedure,Rollback rollback
