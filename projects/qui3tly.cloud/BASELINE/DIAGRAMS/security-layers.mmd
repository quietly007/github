graph TB
    subgraph Layers["üõ°Ô∏è Defense-in-Depth Security Architecture"]
        direction TB
        
        subgraph Layer1["Layer 1: Network Perimeter üåê"]
            direction LR
            
            Firewall[Firewall - iptables<br/>‚Ä¢ Allow: 80, 443, mail ports<br/>‚Ä¢ Drop: All other incoming<br/>‚Ä¢ Rate limiting<br/>‚Ä¢ Connection tracking]
            
            PublicPorts[Public Exposure<br/>Master: 80, 443, 51820<br/>Lady: 80, 443, 25, 587, 993]
            
            GeoBlock[Geographic Filtering<br/>‚Ä¢ CrowdSec IP lists<br/>‚Ä¢ Known bad actors<br/>‚Ä¢ VPN detection]
        end
        
        subgraph Layer2["Layer 2: VPN Access üîê"]
            direction LR
            
            Tailscale[Tailscale Mesh VPN<br/>‚Ä¢ Zero-trust networking<br/>‚Ä¢ Device authentication<br/>‚Ä¢ Encrypted traffic<br/>‚Ä¢ 100.64.0.0/10]
            
            WireGuard[WireGuard P2P<br/>‚Ä¢ Site-to-site tunnel<br/>‚Ä¢ Cryptokey routing<br/>‚Ä¢ 10.10.0.0/30]
            
            AdminOnly[Admin Interfaces<br/>VPN-only access:<br/>‚Ä¢ Portainer<br/>‚Ä¢ Prometheus<br/>‚Ä¢ Postgres<br/>‚Ä¢ Redis]
        end
        
        subgraph Layer3["Layer 3: Reverse Proxy + IPS üö¶"]
            direction LR
            
            Traefik[Traefik Reverse Proxy<br/>‚Ä¢ TLS termination<br/>‚Ä¢ Rate limiting: 100 req/min<br/>‚Ä¢ Header security<br/>‚Ä¢ Access logs]
            
            CrowdSec[CrowdSec IPS<br/>‚Ä¢ 42,345 rules<br/>‚Ä¢ Community intel<br/>‚Ä¢ ML detection<br/>‚Ä¢ Auto-ban 4-24h]
            
            Bouncer[Traefik Bouncer<br/>‚Ä¢ Real-time blocking<br/>‚Ä¢ 1,247 bans (30d)<br/>‚Ä¢ Whitelist management]
            
            Fail2ban[Fail2ban<br/>‚Ä¢ SSH brute-force<br/>‚Ä¢ Auth failures<br/>‚Ä¢ 54 bans (7d)]
        end
        
        subgraph Layer4["Layer 4: Authentication & Authorization üîë"]
            direction LR
            
            Authelia[Authelia SSO<br/>‚Ä¢ Single Sign-On<br/>‚Ä¢ 2FA/TOTP optional<br/>‚Ä¢ Session: 12h<br/>‚Ä¢ Inactivity: 1h]
            
            ACL[Access Control Lists<br/>‚Ä¢ Domain-based rules<br/>‚Ä¢ Group permissions<br/>‚Ä¢ Default: deny<br/>‚Ä¢ 18 protected services]
            
            MFA[Multi-Factor Auth<br/>‚Ä¢ TOTP (Google Auth)<br/>‚Ä¢ SMS backup<br/>‚Ä¢ Recovery codes]
        end
        
        subgraph Layer5["Layer 5: Application Security üéØ"]
            direction LR
            
            AppAuth[Application Auth<br/>Service-specific:<br/>‚Ä¢ Grafana login<br/>‚Ä¢ Mailcow users<br/>‚Ä¢ Nextcloud accounts]
            
            RBAC[Role-Based Access<br/>‚Ä¢ Admin role<br/>‚Ä¢ User role<br/>‚Ä¢ Read-only<br/>‚Ä¢ Service-specific]
            
            AuditLog[Audit Logging<br/>‚Ä¢ All access logged<br/>‚Ä¢ Loki aggregation<br/>‚Ä¢ 30-day retention<br/>‚Ä¢ SIEM-ready]
        end
    end

    subgraph ThreatProtection["ü¶† Threat Protection"]
        direction TB
        
        subgraph EmailSecurity["Email Security"]
            Rspamd[Rspamd<br/>‚Ä¢ Spam filtering<br/>‚Ä¢ DKIM signing<br/>‚Ä¢ ML-based<br/>‚Ä¢ 6.1% spam rate]
            
            ClamAV[ClamAV<br/>‚Ä¢ Virus scanning<br/>‚Ä¢ Real-time updates<br/>‚Ä¢ 0 viruses (7d)]
            
            Olefy[Olefy<br/>‚Ä¢ Office doc scan<br/>‚Ä¢ Macro detection]
        end
        
        subgraph WebSecurity["Web Security"]
            TLS[TLS/SSL<br/>‚Ä¢ Let's Encrypt<br/>‚Ä¢ A+ grade<br/>‚Ä¢ TLS 1.2/1.3<br/>‚Ä¢ HSTS enabled]
            
            Headers[Security Headers<br/>‚Ä¢ X-Frame-Options<br/>‚Ä¢ CSP<br/>‚Ä¢ X-Content-Type<br/>‚Ä¢ Referrer-Policy]
            
            WAF[WAF Rules<br/>‚Ä¢ CrowdSec bouncer<br/>‚Ä¢ OWASP patterns<br/>‚Ä¢ Rate limiting]
        end
        
        subgraph NetworkSecurity["Network Security"]
            Encryption[Encryption<br/>‚Ä¢ TLS everywhere<br/>‚Ä¢ VPN tunnels<br/>‚Ä¢ At-rest (future)]
            
            Segmentation[Network Segmentation<br/>‚Ä¢ Docker networks<br/>‚Ä¢ Service isolation<br/>‚Ä¢ Minimal exposure]
        end
    end

    subgraph Monitoring2["üëÅÔ∏è Security Monitoring"]
        direction LR
        
        RealTime[Real-time Monitoring<br/>‚Ä¢ Prometheus alerts<br/>‚Ä¢ Log analysis<br/>‚Ä¢ Gotify notifications]
        
        Weekly[Weekly Security Audit<br/>‚Ä¢ Cron: 2am Sunday<br/>‚Ä¢ CrowdSec stats<br/>‚Ä¢ Fail2ban review<br/>‚Ä¢ CVE scan]
        
        Alerts[Security Alerts<br/>‚Ä¢ High CPU (attack?)<br/>‚Ä¢ Failed logins<br/>‚Ä¢ New bans<br/>‚Ä¢ Cert expiry]
    end

    subgraph Compliance["üìã Security Compliance"]
        direction TB
        
        Standards[Following Standards<br/>‚Ä¢ CIS Docker Benchmark<br/>‚Ä¢ NIST Framework<br/>‚Ä¢ OWASP Top 10<br/>‚Ä¢ Mozilla TLS config]
        
        BestPractices[Best Practices<br/>‚Ä¢ Principle of least privilege<br/>‚Ä¢ Defense in depth<br/>‚Ä¢ Security by design<br/>‚Ä¢ Regular updates]
        
        Documentation[Security Docs<br/>‚Ä¢ Policies documented<br/>‚Ä¢ Runbooks ready<br/>‚Ä¢ Incident response<br/>‚Ä¢ Contact info]
    end

    subgraph Vulnerabilities["üîç Vulnerability Management"]
        VulnScan[Weekly Vulnerability Scan<br/>Last: Feb 14, 2026<br/>‚Ä¢ 0 Critical<br/>‚Ä¢ 0 High<br/>‚Ä¢ 2 Medium<br/>‚Ä¢ 5 Low]
        
        Patching[Patching Strategy<br/>‚Ä¢ Critical: 24h<br/>‚Ä¢ High: 7d<br/>‚Ä¢ Medium: 30d<br/>‚Ä¢ Low: Quarterly]
    end

    Internet[üåê Internet<br/>Untrusted]
    
    Internet --> Layer1
    Layer1 --> Layer2
    Layer2 --> Layer3
    Layer3 --> Layer4
    Layer4 --> Layer5
    
    Layer3 --> ThreatProtection
    Layer5 --> Monitoring2
    ThreatProtection --> Monitoring2
    
    Monitoring2 -.->|Alerts| Compliance
    Vulnerabilities -.->|Findings| Patching

    subgraph Stats["üìä Security Statistics (Last 30 Days)"]
        ST1[CrowdSec Bans: 1,247]
        ST2[Fail2ban Bans: 54]
        ST3[Spam Blocked: 234]
        ST4[Viruses Detected: 0]
        ST5[Failed Logins: 18]
        ST6[Critical Vulnerabilities: 0]
        ST7[Security Incidents: 0]
        ST8[TLS Grade: A+]
    end

    classDef network fill:#326ce5,stroke:#fff,stroke-width:2px,color:#fff
    classDef vpn fill:#00d4aa,stroke:#fff,stroke-width:2px,color:#000
    classDef proxy fill:#f77f00,stroke:#fff,stroke-width:2px,color:#fff
    classDef auth fill:#9b59b6,stroke:#fff,stroke-width:2px,color:#fff
    classDef app fill:#16a085,stroke:#fff,stroke-width:2px,color:#fff
    classDef threat fill:#d62828,stroke:#fff,stroke-width:2px,color:#fff

    class Layer1,Firewall network
    class Layer2,Tailscale,WireGuard vpn
    class Layer3,Traefik,CrowdSec proxy
    class Layer4,Authelia,ACL auth
    class Layer5,AppAuth,RBAC app
    class ThreatProtection,EmailSecurity,WebSecurity threat
